#!/usr/bin/env bash
set -euo pipefail

# 万一 zsh などで実行されても bash に切り替える
if [[ -z "${BASH_VERSION:-}" ]]; then
  exec /usr/bin/env bash "$0" "$@"
fi

usage() {
  cat <<'USAGE'
git-ai-msg: generate git commit subject line(s) from staged diff via OpenRouter.

Usage:
  git-ai-msg            # outputs 1 line
  git-ai-msg --n 3      # outputs 3 candidate lines

Env:
  OPENROUTER_API_KEY or OPENROUTER_API_KEY_FILE
  OPENROUTER_MODEL (default: google/gemini-3-flash-preview)
  AI_COMMIT_LANG (default: ja)
  AI_COMMIT_STYLE (default: conventional)  # conventional | plain
  AI_COMMIT_MAX_CHARS (default: 72)
  AI_COMMIT_MAX_BYTES (default: 120000)
  AI_COMMIT_EXCLUDE (optional): space-separated globs, e.g. ".env* secrets/* **/*.pem"
USAGE
}

N=1
while [[ $# -gt 0 ]]; do
  case "$1" in
    --n|-n)
      N="${2:-}"
      shift 2
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      echo "Unknown arg: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

if ! [[ "$N" =~ ^[0-9]+$ ]] || (( N < 1 || N > 10 )); then
  echo "ERROR: --n must be 1..10" >&2
  exit 2
fi

MODEL="${OPENROUTER_MODEL:-google/gemini-3-flash-preview}"
LANG="${AI_COMMIT_LANG:-ja}"
STYLE="${AI_COMMIT_STYLE:-conventional}"   # conventional | plain
MAX_CHARS="${AI_COMMIT_MAX_CHARS:-72}"
MAX_BYTES="${AI_COMMIT_MAX_BYTES:-120000}"

# secrets: file-based
KEY_FILE="${OPENROUTER_API_KEY_FILE:-}"
if [[ -n "${OPENROUTER_API_KEY:-}" ]]; then
  API_KEY="$OPENROUTER_API_KEY"
elif [[ -n "$KEY_FILE" && -f "$KEY_FILE" ]]; then
  API_KEY="$(tr -d '\r\n' < "$KEY_FILE")"
else
  echo "ERROR: set OPENROUTER_API_KEY or OPENROUTER_API_KEY_FILE" >&2
  exit 1
fi
if [[ -z "$API_KEY" ]]; then
  echo "ERROR: OpenRouter API key is empty" >&2
  exit 1
fi

APP_REFERER="${OPENROUTER_HTTP_REFERER:-}"
APP_TITLE="${OPENROUTER_X_TITLE:-git-ai-commit}"

# staged check
if git diff --cached --quiet; then
  echo "ERROR: no staged changes (git add first)" >&2
  exit 2
fi

STATUS="$(git status --porcelain=v1 || true)"

EXCLUDES=()
if [[ -n "${AI_COMMIT_EXCLUDE:-}" ]]; then
  # shellcheck disable=SC2206
  PATTERNS=(${AI_COMMIT_EXCLUDE})
  for p in "${PATTERNS[@]}"; do
    EXCLUDES+=(":(exclude)${p}")
  done
fi

DIFF_CMD=(git diff --cached --no-color --minimal -- .)
if ((${#EXCLUDES[@]})); then
  DIFF_CMD+=("${EXCLUDES[@]}")
fi
DIFF="$("${DIFF_CMD[@]}" || true)"

INPUT="$(printf "## git status\n%s\n\n## git diff --cached\n%s\n" "$STATUS" "$DIFF" | head -c "$MAX_BYTES")"

if [[ "$STYLE" == "conventional" ]]; then
  FORMAT_HINT=$'Use Conventional Commits.\nAllowed types: feat, fix, docs, refactor, perf, test, build, ci, chore, revert.'
else
  FORMAT_HINT="Use a clear imperative subject."
fi

SYSTEM_PROMPT=$(
cat <<EOF
You write excellent git commit subjects.

Rules:
- Output EXACTLY ${N} candidates.
- Each candidate must be on its own line.
- Do NOT add numbering, bullets, quotes, or code fences.
- No trailing period.
- Prefer <= ${MAX_CHARS} characters (soft limit).
- Language: ${LANG}.
- ${FORMAT_HINT}
EOF
)

python3 - <<'PY' \
  "$API_KEY" "$MODEL" "$SYSTEM_PROMPT" "$INPUT" "$APP_REFERER" "$APP_TITLE" "$N"
import json, re, sys, urllib.request

api_key, model, system_prompt, user_input, http_referer, x_title, n_str = sys.argv[1:]
N = int(n_str)

url = "https://openrouter.ai/api/v1/chat/completions"
payload = {
    "model": model,
    "messages": [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_input},
    ],
    "temperature": 0.7 if N > 1 else 0.2,
    "max_tokens": 200,
}

headers = {
    "Authorization": f"Bearer {api_key}",
    "Content-Type": "application/json",
}
if http_referer:
    headers["HTTP-Referer"] = http_referer
if x_title:
    headers["X-Title"] = x_title

req = urllib.request.Request(url, data=json.dumps(payload).encode("utf-8"), headers=headers, method="POST")
with urllib.request.urlopen(req, timeout=30) as r:
    data = json.load(r)

txt = (data.get("choices") or [{}])[0].get("message", {}).get("content", "") or ""
lines = [ln.strip() for ln in txt.splitlines() if ln.strip()]

def normalize(s: str) -> str:
    s = s.strip().strip('"\'')

    # ありがちな番号/箇条書きを除去（モデルがルール違反した場合の保険）
    s = re.sub(r'^\s*[\-\*\u2022]\s*', '', s)
    s = re.sub(r'^\s*\(?\d+\)?[.)：:]\s*', '', s)
    s = re.sub(r'^\s*[A-Za-z]\)[.:]\s*', '', s)
    return s.strip()

cands = []
seen = set()
for ln in lines:
    ln = normalize(ln)
    if not ln:
        continue
    key = ln.lower()
    if key in seen:
        continue
    seen.add(key)
    cands.append(ln)
    if len(cands) >= N:
        break

if not cands:
    raise SystemExit("Empty message returned from model")

# もし不足したら、ある分だけ出す（上流でハンドリング）
for ln in cands:
    print(ln)
PY

